<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoveSpouse Script Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .video-container {
            width: 100%;
            margin-bottom: 20px;
            background-color: #000;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        video {
            width: 100%;
            display: block;
        }
        .no-video {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex-grow: 1;
        }
        #toggleBtn {
            background-color: #4CAF50;
        }
        #toggleBtn:hover {
            background-color: #45a049;
        }
        #toggleBtn.pause {
            background-color: #ff9800;
        }
        #toggleBtn.pause:hover {
            background-color: #e68a00;
        }
        #stopBtn {
            background-color: #f44336;
        }
        #stopBtn:hover {
            background-color: #d32f2f;
        }
        #toggleBtn:disabled, #stopBtn:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
        }
        .status-container {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sync-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            background-color: #999;
        }
        .sync-indicator.active {
            background-color: #4CAF50;
        }
        .mode-selector {
            margin-bottom: 10px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .log-container {
            margin-top: 20px;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            font-family: monospace;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .error {
            color: #f44336;
        }
        .success {
            color: #4CAF50;
        }
        .info {
            color: #2196F3;
        }
        .file-upload {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-label {
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }
        .file-label:hover {
            background-color: #0b7dda;
        }
        .file-name {
            flex-grow: 1;
            padding: 8px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-uploads {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 5px;
            background-color: #ddd;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        .time-display {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LoveSpouse Script Player</h1>
        
        <div class="mode-selector">
            <label for="toyMode">Toy Mode:</label>
            <select id="toyMode">
                <option value="shake">Shake</option>
                <option value="shock1">Shock 1</option>
                <option value="shock2">Shock 2</option>
                <option value="telescope">Telescope</option>
            </select>
        </div>
        
        <div class="file-uploads">
            <div class="file-upload">
                <label for="comboFile" class="file-label">Choose Video & Funscript</label>
                <input type="file" id="comboFile" accept="video/*,.funscript" multiple style="display: none;">
                <span id="comboFileName" class="file-name">No file selected</span>
            </div>
        </div>
        
        <div class="video-container">
            <div id="noVideoMessage" class="no-video">No video loaded</div>
            <video id="videoPlayer" controls style="display: none;"></video>
            <div id="timeDisplay" class="time-display" style="display: none;">00:00 / 00:00</div>
            <div class="progress-bar">
                <div id="progressBar" class="progress"></div>
            </div>
        </div>
        
        <textarea id="scriptInput" placeholder="Script content will appear here after selecting a file..."></textarea>
        
        <div class="controls">
            <button id="toggleBtn" class="play" disabled>▶</button>
            <button id="stopBtn" disabled>⏹</button>
        </div>
        
        <div class="status-container">
            <div>
                <strong>Status:</strong> <span id="statusText">No script loaded</span>
            </div>
            <div class="sync-indicator" id="syncIndicator">Video Sync</div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry">Log messages will appear here...</div>
        </div>
    </div>

    <script>
    const SERVER_URL = 'http://localhost:8080';
    const el = {
        scriptInput: document.getElementById('scriptInput'),
        toyMode: document.getElementById('toyMode'),
        playBtn: document.getElementById('toggleBtn'),
        stopBtn: document.getElementById('stopBtn'),
        status: document.getElementById('statusText'),
        log: document.getElementById('logContainer'),
        fileInput: document.getElementById('comboFile'),
        fileName: document.getElementById('comboFileName'),
        video: document.getElementById('videoPlayer'),
        noVideo: document.getElementById('noVideoMessage'),
        progress: document.getElementById('progressBar'),
        time: document.getElementById('timeDisplay'),
        sync: document.getElementById('syncIndicator')
    };
    const State = { NO_SCRIPT: 0, LOADED: 1, PLAYING: 2, PAUSED: 3 };
    let state = State.NO_SCRIPT, videoLoaded = false, scriptLoaded = false, funscript = [], timeouts = [];

    function log(msg, type = '') {
        const e = document.createElement('div');
        e.className = `log-entry ${type}`;
        e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        el.log.appendChild(e);
        el.log.scrollTop = el.log.scrollHeight;
    }
    function setUI() {
        const s = [
            {d:true,t:'▶',c:'play',s:true},
            {d:false,t:'▶',c:'play',s:false},
            {d:false,t:'⏸',c:'pause',s:false},
            {d:false,t:'▶',c:'play',s:false}
        ][state];
        el.playBtn.disabled = s.d; el.playBtn.textContent = s.t; el.playBtn.className = s.c;
        el.stopBtn.disabled = s.s; el.status.textContent = Object.keys(State)[state].replace('_',' ');
        el.sync.classList.toggle('active', state === State.PLAYING);
    }
    function resetUI() {
        el.scriptInput.value = '';
        el.fileName.textContent = 'No file selected';
        el.fileInput.value = '';
        el.video.style.display = 'none';
        el.noVideo.style.display = 'flex';
        el.video.src = '';
        el.progress.style.width = '0%';
        el.time.style.display = 'none';
        state = State.NO_SCRIPT;
        videoLoaded = scriptLoaded = false;
        setUI();
    }
    function fmtTime(s) {
        const m = Math.floor(s/60), sec = Math.floor(s%60);
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }
    function updateTime() {
        if (videoLoaded && el.video.duration)
            el.time.textContent = `${fmtTime(el.video.currentTime)} / ${fmtTime(el.video.duration)}`;
    }
    function clearTimeouts() { timeouts.forEach(clearTimeout); timeouts = []; }
    function scheduleActions(offset = 0) {
        clearTimeouts();
        funscript.forEach(a => {
            const d = a.at - offset;
            if (d >= 0) timeouts.push(setTimeout(() => sendAction(a), d));
        });
    }
    function sendAction(a) {
        const pos = a.pos || 0, submode = Math.min(9, Math.max(0, Math.floor(pos/11)));
        fetch(`${SERVER_URL}/lovespouse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: el.toyMode.value, submode, duration: 0.05 })
        });
    }
    async function play() {
        if (!videoLoaded || !scriptLoaded) return;
        try { await el.video.play(); } catch(e){ log(`Error playing video: ${e.message}`,'error'); }
        scheduleActions(el.video.currentTime * 1000);
        state = State.PLAYING; setUI();
    }
    function pause() {
        if (!videoLoaded || !scriptLoaded) return;
        el.video.pause();
        clearTimeouts();
        state = State.PAUSED; setUI();
    }
    function stop() {
        el.playBtn.disabled = el.stopBtn.disabled = true;
        if (videoLoaded) { el.video.pause(); el.video.currentTime = 0; }
        clearTimeouts();
        state = State.LOADED; setUI();
    }
    el.fileInput.addEventListener('change', e => {
        const files = Array.from(e.target.files);
        if (files.length !== 2) return alert('Please select both a video file and a funscript file together.'), el.fileInput.value = '', el.fileName.textContent = 'No file selected';
        let v = null, s = null;
        files.forEach(f => {
            if (f.name.toLowerCase().endsWith('.funscript')) s = f;
            else if (f.type.startsWith('video/')) v = f;
        });
        if (!v || !s) return alert('Please select one video file and one funscript file with the same base name.'), el.fileInput.value = '', el.fileName.textContent = 'No file selected';
        el.fileName.textContent = v.name + ' + ' + s.name;
        el.video.src = URL.createObjectURL(v);
        el.video.style.display = 'block';
        el.noVideo.style.display = 'none';
        el.time.style.display = 'block';
        videoLoaded = true;
        log(`Video "${v.name}" loaded`,'success');
        const r = new FileReader();
        r.onload = e => {
            try {
                const parsed = JSON.parse(e.target.result);
                el.scriptInput.value = JSON.stringify(parsed, null, 2);
                log(`Script "${s.name}" loaded`,'success');
                funscript = (parsed.actions||[]).map(a=>({at:a.at,pos:a.pos}));
                scriptLoaded = true;
                state = State.LOADED; setUI();
            } catch(err) { log(`Error parsing script file: ${err.message}`,'error'); }
        };
        r.onerror = () => log('Error reading script file','error');
        r.readAsText(s);
    });
    el.video.addEventListener('play', () => {
        if (state === State.PAUSED) {
            scheduleActions(el.video.currentTime * 1000);
            state = State.PLAYING; setUI();
        } else if (state === State.LOADED) play();
    });
    el.video.addEventListener('pause', () => { if (state === State.PLAYING) pause(); });
    el.video.addEventListener('ended', stop);
    el.video.addEventListener('timeupdate', () => {
        if (videoLoaded && el.video.duration) {
            el.progress.style.width = `${(el.video.currentTime/el.video.duration)*100}%`;
            updateTime();
        }
    });
    el.video.addEventListener('seeked', () => {
        if (state === State.PLAYING) {
            scheduleActions(el.video.currentTime * 1000);
        } else if (state === State.PAUSED) {
            clearTimeouts();
        }
    });
    el.playBtn.addEventListener('click', () => { state === State.PLAYING ? pause() : play(); });
    el.stopBtn.addEventListener('click', stop);
    setUI();
    </script>
</body>
</html>
